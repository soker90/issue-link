name: CI

on:
  push:
    branches:
      - source
  issues:
    types:
      [
        opened,
        closed,
        edited,
        milestoned,
        labeled,
        unlabeled,
        reopened,
        demilestoned,
      ]

  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Issue Title
        id: check-issue-title
        run: |
          if [[ "${{ github.event.issue.title }}" != "[link]*" ]]; then
            echo "The issue title does not start with [link]. Exiting workflow."
            exit 0
          fi

      - name: Download Issue
        uses: actions/github-script@v5
        id: download-issue
        with:
          github-token: 1
          script: |
            const issue = ${{toJSON(github.event.issue)}}

            const script = require('./.github/scripts/save-markdown.cjs')
            await script({github, context, core, exec, issue: ${{toJSON(github.event.issue)}} }, 'src/content/post')

  
      - name: Update markdown file
        uses: EndBug/add-and-commit@v7
        env:
          GITHUB_USER: soker90
          GITHUB_EMAIL: eduparra90@gmail.com
        with:
          add: 'src/content/link'
          author_name: ${{ env.GITHUB_USER }}
          author_email: ${{ env.GITHUB_EMAIL }}
          message: 'Update issue file'
